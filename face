from flask import Flask, render_template, request, redirect
import cv2
import os
import numpy as np
from PIL import Image
from datetime import datetime
import csv

app = Flask(__name__)

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/capture', methods=['POST'])
def capture():
    user_id = request.form['user_id']
    user_name = request.form['user_name']

    # Save name to students.csv
    if not os.path.exists("students.csv"):
        with open("students.csv", "w", newline='') as f:
            writer = csv.writer(f)
            writer.writerow(["ID", "Name"])

    with open("students.csv", "a", newline='') as f:
        writer = csv.writer(f)
        writer.writerow([user_id, user_name])

    face_classifier = cv2.CascadeClassifier(cv2.data.haarcascades + 'haarcascade_frontalface_default.xml')
    cam = cv2.VideoCapture(0)
    count = 0
    if not os.path.exists("dataset"):
        os.makedirs("dataset")

    def face_extractor(img):
        faces = face_classifier.detectMultiScale(img, 1.3, 5)
        if faces is None or len(faces) == 0:
            return None
        for (x, y, w, h) in faces:
            return img[y:y+h, x:x+w]

    while True:
        ret, frame = cam.read()
        gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
        face = face_extractor(gray)

        if face is not None:
            count += 1
            face = cv2.resize(face, (200, 200))
            file_name_path = f'dataset/user.{user_id}.{count}.jpg'
            cv2.imwrite(file_name_path, face)
            cv2.putText(face, str(count), (50, 50), cv2.FONT_HERSHEY_SIMPLEX, 1, (255,255,255), 2)
            cv2.imshow('Capturing Faces', face)
        else:
            print("Face not found")

        if cv2.waitKey(1) == 13 or count == 50:
            break

    cam.release()
    cv2.destroyAllWindows()
    return redirect('/')

@app.route('/train', methods=['POST'])
def train():
    recognizer = cv2.face.LBPHFaceRecognizer_create()
    face_cascade = cv2.CascadeClassifier(cv2.data.haarcascades + 'haarcascade_frontalface_default.xml')

    image_dir = 'dataset'
    faces = []
    ids = []

    for image_name in os.listdir(image_dir):
        if not image_name.lower().endswith((".jpg", ".jpeg", ".png")):
            continue
        img_path = os.path.join(image_dir, image_name)
        gray_img = Image.open(img_path).convert('L')
        image_np = np.array(gray_img, 'uint8')

        try:
            user_id = int(image_name.split('.')[1])
        except:
            continue

        faces_detected = face_cascade.detectMultiScale(image_np)
        for (x, y, w, h) in faces_detected:
            faces.append(image_np[y:y+h, x:x+w])
            ids.append(user_id)

    if faces:
        recognizer.train(faces, np.array(ids))
        recognizer.save('trainer.yml')

    return redirect('/')

def load_name_mapping():
    name_map = {}
    if os.path.exists("students.csv"):
        with open("students.csv", "r") as f:
            reader = csv.DictReader(f)
            for row in reader:
                name_map[int(row["ID"])] = row["Name"]
    return name_map

@app.route('/recognize', methods=['POST'])
def recognize():
    if not os.path.exists('trainer.yml'):
        print("Trainer file not found! Please train the model first.")
        return redirect('/')

    name_map = load_name_mapping()
    recognizer = cv2.face.LBPHFaceRecognizer_create()
    recognizer.read('trainer.yml')
    face_cascade = cv2.CascadeClassifier(cv2.data.haarcascades + 'haarcascade_frontalface_default.xml')

    cam = cv2.VideoCapture(0)
    recognized_ids = set()

    def mark_attendance(user_id, user_name):
        if user_id not in recognized_ids:
            recognized_ids.add(user_id)
            with open("attendance.csv", "a") as f:
                time_now = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                f.write(f"{user_id},{user_name},{time_now}\n")
            print(f" Attendance marked for {user_name} (ID: {user_id})")

    print("üîç Starting face recognition. Press Enter to stop.")

    while True:
        ret, frame = cam.read()
        gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
        faces = face_cascade.detectMultiScale(gray, 1.2, 5)

        for (x, y, w, h) in faces:
            roi_gray = gray[y:y+h, x:x+w]
            user_id, confidence = recognizer.predict(roi_gray)
            user_name = name_map.get(user_id, "Unknown")

            print(f"Detected face. ID: {user_id}, Name: {user_name}, Confidence: {confidence:.2f}")

            if confidence < 55:
                label = f"{user_name}"
                mark_attendance(user_id, user_name)
                color = (0, 255, 0)
            else:
                label = "Unknown"
                color = (0, 0, 255)

            cv2.putText(frame, label, (x, y - 10), cv2.FONT_HERSHEY_SIMPLEX, 1, color, 2)
            cv2.rectangle(frame, (x, y), (x + w, y + h), color, 2)

        cv2.imshow("Recognition", frame)
        if cv2.waitKey(1) == 13:
            break

    cam.release()
    cv2.destroyAllWindows()
    return redirect('/')

if __name__ == '__main__':
    app.run(debug=True)
